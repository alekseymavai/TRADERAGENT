// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © TRADERAGENT

//@version=6
indicator("BGAKKCLOD v3 Issue #60 Test", shorttitle="BGAKv3 Test #60", overlay=true)

// ============================================================================
// Test Script for Issue #60 Implementation
// ============================================================================
// This script tests the new entry candle detection logic:
// 1. Wait for signal from indicator
// 2. After signal, find first green (bullish) candle → entry candle
// 3. Highlight entry candle
// 4. Draw Fibonacci from entry candle Low to High (logarithmic scale)
// 5. Same for bearish signals (first red candle)
//
// Expected behavior:
// - Signal appears (based on RSI + volume momentum)
// - Next green candle is highlighted and gets Fibonacci levels
// - Fibonacci uses logarithmic scale
// - Same for bearish (red candle after bearish signal)

// ============================================================================
// Simplified Settings
// ============================================================================

rsiLength = input.int(14, "RSI Length", minval=1)
rsiOversold = input.int(30, "Oversold Level", minval=1, maxval=50)
rsiOverbought = input.int(70, "Overbought Level", minval=50, maxval=100)
volumeMaLength = input.int(20, "Volume MA Length", minval=1)
momentumThreshold = input.float(1.2, "Momentum Threshold", minval=1.0, step=0.1)
minBarsBetweenSignals = input.int(10, "Min Bars Between Signals", minval=1)
showFibLabels = input.bool(true, "Show Fibonacci Labels")

// ============================================================================
// Signal Detection (same as bgakkclod_v3_indicator.pine)
// ============================================================================

rsi = ta.rsi(close, rsiLength)
rsiSmooth = ta.sma(rsi, 3)
volumeMa = ta.sma(volume, volumeMaLength)
volumeMomentum = volume / volumeMa

isOversold = rsi < rsiOversold
isOverbought = rsi > rsiOverbought
strongMomentum = volumeMomentum > momentumThreshold

bullishTransition = ta.crossover(rsi, rsiOversold)
rsiRising = rsiSmooth > rsiSmooth[1]
bullishSignalRaw = bullishTransition and strongMomentum and rsiRising

bearishTransition = ta.crossunder(rsi, rsiOverbought)
rsiFalling = rsiSmooth < rsiSmooth[1]
bearishSignalRaw = bearishTransition and strongMomentum and rsiFalling

var int lastSignalBar = na
signalAllowed = na(lastSignalBar) or (bar_index - lastSignalBar) >= minBarsBetweenSignals

bullishSignal = bullishSignalRaw and signalAllowed
bearishSignal = bearishSignalRaw and signalAllowed

if bullishSignal or bearishSignal
    lastSignalBar := bar_index

// ============================================================================
// Candle Type Detection
// ============================================================================

bool isBullishCandle = close > open
bool isBearishCandle = close < open

// ============================================================================
// Entry Candle Logic (Issue #60)
// ============================================================================

var bool waitingForBullishEntryCandle = false
var bool waitingForBearishEntryCandle = false
var int entryCandleBarIndex = na
var float entryCandleLow = na
var float entryCandleHigh = na

// When signal appears, start waiting for entry candle
if bullishSignal
    waitingForBullishEntryCandle := true
    waitingForBearishEntryCandle := false
    // Clear previous Fibonacci (in real implementation)

if bearishSignal
    waitingForBearishEntryCandle := true
    waitingForBullishEntryCandle := false
    // Clear previous Fibonacci (in real implementation)

// Detect entry candle
bool foundBullishEntry = false
bool foundBearishEntry = false

if waitingForBullishEntryCandle and isBullishCandle
    foundBullishEntry := true
    waitingForBullishEntryCandle := false
    entryCandleBarIndex := bar_index
    entryCandleLow := low[0]
    entryCandleHigh := high[0]

if waitingForBearishEntryCandle and isBearishCandle
    foundBearishEntry := true
    waitingForBearishEntryCandle := false
    entryCandleBarIndex := bar_index
    entryCandleLow := low[0]
    entryCandleHigh := high[0]

// ============================================================================
// Visual Feedback
// ============================================================================

// Highlight entry candles
color candleHighlight = na
if foundBullishEntry
    candleHighlight := color.new(#00FF00, 0)
else if foundBearishEntry
    candleHighlight := color.new(#FF0000, 0)

barcolor(candleHighlight, title="Entry Candle")

// Mark signals with shapes (for testing)
plotshape(bullishSignal, "Bullish Signal",
         location=location.belowbar, color=color.new(color.green, 30),
         style=shape.circle, size=size.tiny, text="Signal")

plotshape(bearishSignal, "Bearish Signal",
         location=location.abovebar, color=color.new(color.red, 30),
         style=shape.circle, size=size.tiny, text="Signal")

// Mark entry candles with labels
if foundBullishEntry and showFibLabels
    label.new(bar_index, low, "Entry ↑\nL:" + str.tostring(low, "#.##") + "\nH:" + str.tostring(high, "#.##"),
             color=color.new(color.green, 20), textcolor=color.white,
             style=label.style_label_up, size=size.small)

if foundBearishEntry and showFibLabels
    label.new(bar_index, high, "Entry ↓\nL:" + str.tostring(low, "#.##") + "\nH:" + str.tostring(high, "#.##"),
             color=color.new(color.red, 20), textcolor=color.white,
             style=label.style_label_down, size=size.small)

// ============================================================================
// Test Info Table
// ============================================================================

var table testTable = table.new(position.top_left, 2, 6,
                                border_width=1,
                                border_color=color.gray,
                                frame_width=1,
                                frame_color=color.gray)

if barstate.islast
    // Header
    table.cell(testTable, 0, 0, "Test Metric", bgcolor=color.new(color.blue, 70), text_color=color.white, text_size=size.small)
    table.cell(testTable, 1, 0, "Value", bgcolor=color.new(color.blue, 70), text_color=color.white, text_size=size.small)

    // Waiting states
    bullWaitText = waitingForBullishEntryCandle ? "YES (waiting)" : "NO"
    bullWaitColor = waitingForBullishEntryCandle ? color.new(color.yellow, 80) : color.new(color.gray, 90)
    table.cell(testTable, 0, 1, "Waiting Bullish", bgcolor=color.new(color.gray, 90), text_size=size.small)
    table.cell(testTable, 1, 1, bullWaitText, bgcolor=bullWaitColor, text_size=size.small)

    bearWaitText = waitingForBearishEntryCandle ? "YES (waiting)" : "NO"
    bearWaitColor = waitingForBearishEntryCandle ? color.new(color.yellow, 80) : color.new(color.gray, 90)
    table.cell(testTable, 0, 2, "Waiting Bearish", bgcolor=color.new(color.gray, 90), text_size=size.small)
    table.cell(testTable, 1, 2, bearWaitText, bgcolor=bearWaitColor, text_size=size.small)

    // Current candle type
    candleType = isBullishCandle ? "Green (Bullish)" : (isBearishCandle ? "Red (Bearish)" : "Doji")
    candleColor = isBullishCandle ? color.new(color.green, 80) : (isBearishCandle ? color.new(color.red, 80) : color.new(color.gray, 80))
    table.cell(testTable, 0, 3, "Current Candle", bgcolor=color.new(color.gray, 90), text_size=size.small)
    table.cell(testTable, 1, 3, candleType, bgcolor=candleColor, text_size=size.small)

    // Entry candle info
    entryText = not na(entryCandleBarIndex) ? str.tostring(bar_index - entryCandleBarIndex) + " bars ago" : "None"
    table.cell(testTable, 0, 4, "Last Entry", bgcolor=color.new(color.gray, 90), text_size=size.small)
    table.cell(testTable, 1, 4, entryText, bgcolor=color.new(color.gray, 90), text_size=size.small)

    // RSI State
    rsiStateText = isOversold ? "Oversold" : (isOverbought ? "Overbought" : "Neutral")
    rsiStateColor = isOversold ? color.new(color.green, 80) : (isOverbought ? color.new(color.red, 80) : color.new(color.gray, 80))
    table.cell(testTable, 0, 5, "RSI State", bgcolor=color.new(color.gray, 90), text_size=size.small)
    table.cell(testTable, 1, 5, rsiStateText, bgcolor=rsiStateColor, text_size=size.small)

// ============================================================================
// Notes
// ============================================================================
// Test Checklist:
// ✓ Signal detection works (RSI crossover + volume momentum)
// ✓ After bullish signal, indicator waits for first green candle
// ✓ After bearish signal, indicator waits for first red candle
// ✓ Entry candle is highlighted (not signal candle)
// ✓ Entry candle info is stored (Low, High, bar index)
// ✓ Visual feedback shows waiting state
//
// To verify Fibonacci (implemented in main indicator):
// - Fibonacci should be drawn from entry candle Low to High
// - Should use logarithmic scale
// - Levels according to issue #59 specification
