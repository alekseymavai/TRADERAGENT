// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © TRADERAGENT

//@version=6
indicator("RSI Divergence Test (Issue #68)", shorttitle="RSI Div Test", overlay=true, max_lines_count=50)

// ============================================================================
// ОПИСАНИЕ / DESCRIPTION
// ============================================================================
// Тестовый индикатор для проверки определения дивергенций RSI (issue #68)
// Test indicator for RSI divergence detection (issue #68)
//
// Этот индикатор создан для тестирования и отладки алгоритма определения
// дивергенций RSI перед интеграцией в основные индикаторы.
//
// This indicator is created for testing and debugging the RSI divergence
// detection algorithm before integration into main indicators.

// ============================================================================
// ВХОДНЫЕ ПАРАМЕТРЫ / INPUTS
// ============================================================================

// RSI Settings
rsiLength = input.int(14, "RSI Length", minval=1, group="RSI Settings")
rsiOversold = input.int(30, "Oversold Level", minval=1, maxval=50, group="RSI Settings")
rsiOverbought = input.int(70, "Overbought Level", minval=50, maxval=100, group="RSI Settings")

// Divergence Settings
divergenceLookback = input.int(5, "Divergence Lookback (bars)", minval=2, maxval=20, group="Divergence Settings")
minDivergenceStrength = input.float(0.05, "Min Divergence Strength", minval=0.01, step=0.01, group="Divergence Settings")
showDivergenceLines = input.bool(true, "Show Divergence Lines", group="Divergence Settings")

// Display Settings
showPivotMarkers = input.bool(true, "Show Pivot Markers", group="Display Settings")
showDivergenceLabels = input.bool(true, "Show Divergence Labels", group="Display Settings")

// ============================================================================
// ВЫЧИСЛЕНИЕ ИНДИКАТОРОВ / INDICATOR CALCULATIONS
// ============================================================================

// RSI Calculation
rsi = ta.rsi(close, rsiLength)

// Find pivot points for price
pivotLow = ta.pivotlow(low, divergenceLookback, divergenceLookback)
pivotHigh = ta.pivothigh(high, divergenceLookback, divergenceLookback)

// Find pivot points for RSI
rsiPivotLow = ta.pivotlow(rsi, divergenceLookback, divergenceLookback)
rsiPivotHigh = ta.pivothigh(rsi, divergenceLookback, divergenceLookback)

// Store previous pivot values
var float prevPriceLow = na
var float prevPriceHigh = na
var float prevRsiLow = na
var float prevRsiHigh = na
var int prevPriceLowBar = na
var int prevPriceHighBar = na

// Update previous pivots when new pivot is found
if not na(pivotLow)
    prevPriceLow := pivotLow
    prevPriceLowBar := bar_index - divergenceLookback

if not na(pivotHigh)
    prevPriceHigh := pivotHigh
    prevPriceHighBar := bar_index - divergenceLookback

if not na(rsiPivotLow)
    prevRsiLow := rsiPivotLow

if not na(rsiPivotHigh)
    prevRsiHigh := rsiPivotHigh

// ============================================================================
// ОПРЕДЕЛЕНИЕ ДИВЕРГЕНЦИЙ / DIVERGENCE DETECTION
// ============================================================================

// Detect bullish divergence
bullishDivergence = false
bullishDivergenceStrength = 0.0

if not na(pivotLow) and not na(prevPriceLow) and not na(rsiPivotLow) and not na(prevRsiLow)
    priceLowerLow = pivotLow < prevPriceLow
    rsiHigherLow = rsiPivotLow > prevRsiLow
    inOversoldZone = rsiPivotLow < rsiOversold

    if priceLowerLow and rsiHigherLow and inOversoldZone
        bullishDivergence := true
        bullishDivergenceStrength := prevRsiLow != 0 ? (rsiPivotLow - prevRsiLow) / prevRsiLow : 0.0

// Detect bearish divergence
bearishDivergence = false
bearishDivergenceStrength = 0.0

if not na(pivotHigh) and not na(prevPriceHigh) and not na(rsiPivotHigh) and not na(prevRsiHigh)
    priceHigherHigh = pivotHigh > prevPriceHigh
    rsiLowerHigh = rsiPivotHigh < prevRsiHigh
    inOverboughtZone = rsiPivotHigh > rsiOverbought

    if priceHigherHigh and rsiLowerHigh and inOverboughtZone
        bearishDivergence := true
        bearishDivergenceStrength := prevRsiHigh != 0 ? (prevRsiHigh - rsiPivotHigh) / prevRsiHigh : 0.0

// Filter weak divergences
strongBullishDivergence = bullishDivergence and bullishDivergenceStrength > minDivergenceStrength
strongBearishDivergence = bearishDivergence and bearishDivergenceStrength > minDivergenceStrength

// ============================================================================
// ВИЗУАЛИЗАЦИЯ / VISUALIZATION
// ============================================================================

// Draw pivot markers
if showPivotMarkers
    if not na(pivotLow)
        label.new(bar_index - divergenceLookback, low[divergenceLookback],
                 text="L",
                 color=color.new(color.blue, 80),
                 textcolor=color.white,
                 style=label.style_label_up,
                 size=size.tiny)

    if not na(pivotHigh)
        label.new(bar_index - divergenceLookback, high[divergenceLookback],
                 text="H",
                 color=color.new(color.blue, 80),
                 textcolor=color.white,
                 style=label.style_label_down,
                 size=size.tiny)

// Draw divergence lines
var line[] divergenceLines = array.new<line>()
maxDivergenceLines = 20

if showDivergenceLines and strongBullishDivergence and not na(prevPriceLowBar)
    if array.size(divergenceLines) >= maxDivergenceLines
        oldLine = array.shift(divergenceLines)
        line.delete(oldLine)

    newLine = line.new(
        x1 = prevPriceLowBar,
        y1 = prevPriceLow,
        x2 = bar_index - divergenceLookback,
        y2 = pivotLow,
        color = color.new(color.green, 30),
        style = line.style_dashed,
        width = 2
    )
    array.push(divergenceLines, newLine)

if showDivergenceLines and strongBearishDivergence and not na(prevPriceHighBar)
    if array.size(divergenceLines) >= maxDivergenceLines
        oldLine = array.shift(divergenceLines)
        line.delete(oldLine)

    newLine = line.new(
        x1 = prevPriceHighBar,
        y1 = prevPriceHigh,
        x2 = bar_index - divergenceLookback,
        y2 = pivotHigh,
        color = color.new(color.red, 30),
        style = line.style_dashed,
        width = 2
    )
    array.push(divergenceLines, newLine)

// Draw divergence labels
if showDivergenceLabels and strongBullishDivergence
    label.new(bar_index - divergenceLookback, low[divergenceLookback],
             text="Bullish Div\n" + str.tostring(bullishDivergenceStrength * 100, "#.#") + "%",
             color=color.new(color.green, 0),
             textcolor=color.white,
             style=label.style_label_up,
             size=size.small)

if showDivergenceLabels and strongBearishDivergence
    label.new(bar_index - divergenceLookback, high[divergenceLookback],
             text="Bearish Div\n" + str.tostring(bearishDivergenceStrength * 100, "#.#") + "%",
             color=color.new(color.red, 0),
             textcolor=color.white,
             style=label.style_label_down,
             size=size.small)

// ============================================================================
// ИНФОРМАЦИОННАЯ ТАБЛИЦА / INFO TABLE
// ============================================================================

var table infoTable = table.new(position.top_right, 2, 8,
                                border_width=1,
                                border_color=color.gray,
                                frame_width=1,
                                frame_color=color.gray)

if barstate.islast
    // Header
    table.cell(infoTable, 0, 0, "Metric", bgcolor=color.new(color.blue, 70), text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 0, "Value", bgcolor=color.new(color.blue, 70), text_color=color.white, text_size=size.small)

    // RSI
    rsiColor = rsi < rsiOversold ? color.new(color.green, 80) : (rsi > rsiOverbought ? color.new(color.red, 80) : color.new(color.gray, 80))
    table.cell(infoTable, 0, 1, "RSI", bgcolor=color.new(color.gray, 90), text_size=size.small)
    table.cell(infoTable, 1, 1, str.tostring(rsi, "#.##"), bgcolor=rsiColor, text_size=size.small)

    // Previous Price Low
    prevPriceLowText = not na(prevPriceLow) ? str.tostring(prevPriceLow, "#.####") : "N/A"
    table.cell(infoTable, 0, 2, "Prev Price Low", bgcolor=color.new(color.gray, 90), text_size=size.small)
    table.cell(infoTable, 1, 2, prevPriceLowText, bgcolor=color.new(color.gray, 90), text_size=size.small)

    // Previous Price High
    prevPriceHighText = not na(prevPriceHigh) ? str.tostring(prevPriceHigh, "#.####") : "N/A"
    table.cell(infoTable, 0, 3, "Prev Price High", bgcolor=color.new(color.gray, 90), text_size=size.small)
    table.cell(infoTable, 1, 3, prevPriceHighText, bgcolor=color.new(color.gray, 90), text_size=size.small)

    // Previous RSI Low
    prevRsiLowText = not na(prevRsiLow) ? str.tostring(prevRsiLow, "#.##") : "N/A"
    table.cell(infoTable, 0, 4, "Prev RSI Low", bgcolor=color.new(color.gray, 90), text_size=size.small)
    table.cell(infoTable, 1, 4, prevRsiLowText, bgcolor=color.new(color.gray, 90), text_size=size.small)

    // Previous RSI High
    prevRsiHighText = not na(prevRsiHigh) ? str.tostring(prevRsiHigh, "#.##") : "N/A"
    table.cell(infoTable, 0, 5, "Prev RSI High", bgcolor=color.new(color.gray, 90), text_size=size.small)
    table.cell(infoTable, 1, 5, prevRsiHighText, bgcolor=color.new(color.gray, 90), text_size=size.small)

    // Bullish Divergence
    bullishDivStatus = strongBullishDivergence ? "YES (" + str.tostring(bullishDivergenceStrength * 100, "#.#") + "%)" : "No"
    bullishDivColor = strongBullishDivergence ? color.new(color.green, 80) : color.new(color.gray, 80)
    table.cell(infoTable, 0, 6, "Bullish Divergence", bgcolor=color.new(color.gray, 90), text_size=size.small)
    table.cell(infoTable, 1, 6, bullishDivStatus, bgcolor=bullishDivColor, text_size=size.small)

    // Bearish Divergence
    bearishDivStatus = strongBearishDivergence ? "YES (" + str.tostring(bearishDivergenceStrength * 100, "#.#") + "%)" : "No"
    bearishDivColor = strongBearishDivergence ? color.new(color.red, 80) : color.new(color.gray, 80)
    table.cell(infoTable, 0, 7, "Bearish Divergence", bgcolor=color.new(color.gray, 90), text_size=size.small)
    table.cell(infoTable, 1, 7, bearishDivStatus, bgcolor=bearishDivColor, text_size=size.small)

// ============================================================================
// ALERTS
// ============================================================================

alertcondition(strongBullishDivergence, "Bullish Divergence", "RSI Bullish Divergence detected!")
alertcondition(strongBearishDivergence, "Bearish Divergence", "RSI Bearish Divergence detected!")

// ============================================================================
// NOTES
// ============================================================================

// Тестовый индикатор для отладки определения дивергенций RSI
// Test indicator for debugging RSI divergence detection
//
// Features:
// - Визуализация pivot points (локальных экстремумов)
// - Visualization of pivot points (local extrema)
// - Отрисовка линий дивергенций
// - Drawing divergence lines
// - Метки с силой дивергенции
// - Labels with divergence strength
// - Информационная таблица с текущими значениями
// - Info table with current values
//
// Используйте этот индикатор для:
// Use this indicator to:
// - Проверки корректности определения дивергенций
// - Verify correctness of divergence detection
// - Настройки параметров (lookback, strength threshold)
// - Tune parameters (lookback, strength threshold)
// - Визуального анализа качества сигналов
// - Visual analysis of signal quality
